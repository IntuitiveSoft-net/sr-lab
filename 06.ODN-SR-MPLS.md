# SR-MPLS VPN and ODN

## SR-MPLS VPN

### Task 1. Verify BGP configuration

Visualize the BGP configuration. Router xrd-7 is configured to act as a route reflector server for the two PE : router xrd-1 and xrd-2

:keyboard: xrd-1
```bash
show run router bgp
```
```
router bgp 65000
 bgp router-id 1.1.1.1
 address-family vpnv4 unicast
 !
 neighbor-group RR-PCE
  remote-as 65000
  update-source Loopback0
  address-family vpnv4 unicast
  !
 !
 neighbor 7.7.7.7
  use neighbor-group RR-PCE
 !
!
```

:information_source: The configuration is similar on xrd-2

Verify BGP neighbor connection status.

:keyboard: xrd-1
```bash
show bgp neighbor brief
```
```
Neighbor        Spk    AS Description                          Up/Down  NBRState
7.7.7.7           0   100                                      20:25:16 Established 
```

### Task 2. Create a VRF 

Create a VRF on xrd-1 and xrd-2:

:keyboard: xrd-1
```bash
vrf customer1
 address-family ipv4 unicast
  import route-target
   10:10
  !
  export route-target
   10:10
  !
 !
!
interface loopback 10
 vrf customer1
 ipv4 address 10.10.10.1/32
!
router bgp 65000
 vrf customer1
  rd 65000:1
  address-family ipv4 unicast
   redistribute connected
  !
 !
!
commit
end
exit
```

```bash
xrd 2
```

:keyboard: xrd-2
```bash
config
vrf customer1
 address-family ipv4 unicast
  import route-target
   10:10
  !
  export route-target
   10:10
  !
 !
!
interface loopback 10
 vrf customer1
 ipv4 address 10.10.10.2/32
!
router bgp 65000
 vrf customer1
  rd 65000:1
  address-family ipv4 unicast
   redistribute connected
  !
 !
!
commit
end
exit
```

:keyboard: xrd-1
```bash
show ip route vrf customer1 
```
```
Codes: C - connected, S - static, R - RIP, B - BGP, (>) - Diversion path
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP
       i - ISIS, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, su - IS-IS summary null, * - candidate default
       U - per-user static route, o - ODR, L - local, G  - DAGR, l - LISP
       A - access/subscriber, a - Application route
       M - mobile route, r - RPL, t - Traffic Engineering, (!) - FRR Backup path

Gateway of last resort is not set

C    99.1.10.0/24 is directly connected, 00:04:57, GigabitEthernet0/0/0/2
L    99.1.10.1/32 is directly connected, 00:04:57, GigabitEthernet0/0/0/2
B    99.2.20.0/24 [200/0] via 2.2.2.2 (nexthop in vrf default), 00:00:03
```

:keyboard: xrd-1
```bash
show bgp vpnv4 uni
```
```
BGP router identifier 1.1.1.1, local AS number 100
BGP generic scan interval 60 secs
Non-stop routing is enabled
BGP table state: Active
Table ID: 0x0
BGP main routing table version 5
BGP NSR Initial initsync version 1 (Reached)
BGP NSR/ISSU Sync-Group versions 0/0
BGP scan interval 60 secs

Status codes: s suppressed, d damped, h history, * valid, > best
              i - internal, r RIB-failure, S stale, N Nexthop-discard
Origin codes: i - IGP, e - EGP, ? - incomplete
   Network            Next Hop            Metric LocPrf Weight Path
Route Distinguisher: 1.1.1.1:0 (default for vrf customer1)
Route Distinguisher Version: 5
*> 99.1.10.0/24       0.0.0.0                  0         32768 ?
*>i99.2.20.0/24       2.2.2.2                  0    100      0 ?
Route Distinguisher: 2.2.2.2:0
Route Distinguisher Version: 4
*>i99.2.20.0/24       2.2.2.2                  0    100      0 ?

Processed 3 prefixes, 3 paths
```

```bash
ping vrf customer1 99.2.20.2
```
```
Thu Nov  3 11:48:48.869 UTC
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 99.2.20.2, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/2 ms
```

```bash
config
!
extcommunity-set opaque BEST_EFFORT
 300
end-set
!
route-policy BEST_EFFORT
 set extcommunity color BEST_EFFORT
end
!
vrf customer1
 address-family ipv4 unicast
  export route-policy BEST_EFFORT
 !
!
commit
end
```

sh bgp vpnv4 uni
sh bgp vpnv4 uni rd 100:100 100.6.6.6/32 detail
sh route vrf vrf100 100.6.6.6/32
show cef vrf vrf100 100.6.6.6/32 detail
show segment-routing traffic-eng policy color 200


## On Demand Next Hop (ODN)

For a given head-end node, a SR-Policy is defined by a tuple color,destination. In a scenario where you have several destinations with the same policy intent it would be more efficient and simple to use a policy template.

If a service head-end needs to send traffic to a prefix matching a color, it automatically instantiates an SR Policy to a BGP next-hop when required (on-demand).
The `color` BGP community is used as SLA indicator to match the policy color definition on the head-end node.

A mechanism called Automated Steering (AS) automatically steers the BGP traffic into this SR Policy, also based on nexthop and color.

Configure an SR Policy template for each color for which on-demand SR Policy instantiation is desired
An example with two color templates configured:
color 200 for high bandwidth (optimize IGP metric)
color 300 for low-delay (optimize link-delay metric)


```bash
segment-routing
 traffic-eng
  on-demand color 300
   dynamic
    metric
     type te
    !
   !
  !
 !
!
commit
end

```


```bash
config
!
extcommunity-set opaque LOW_DELAY
 300
end-set
!
route-policy LOW_DELAY
 set extcommunity color LOW_DELAY
end
!
vrf customer1
 address-family ipv4 unicast
  export route-policy LOW_DELAY
 !
!
commit
end
```


```
RP/0/RP0/CPU0:xrd-1#sh segment-routing traffic-eng policy color 300 detail 
Tue Dec  6 10:51:47.831 UTC

SR-TE policy database
---------------------

Color: 300, End-point: 2.2.2.2
  Name: srte_c_300_ep_2.2.2.2
  Status:
    Admin: up  Operational: up for 00:00:06 (since Dec  6 10:51:41.029)
  Candidate-paths:
    Preference: 200 (BGP ODN) (active)
      Requested BSID: dynamic
      Constraints:
        Protection Type: protected-preferred
        Maximum SID Depth: 10 
      Dynamic (valid)
        Metric Type: TE,   Path Accumulated Metric: 30 
          16002 [Prefix-SID, 2.2.2.2]
    Preference: 100 (BGP ODN) (inactive)
      Requested BSID: dynamic
      PCC info:
        Symbolic name: bgp_c_300_ep_2.2.2.2_discr_100
        PLSP-ID: 1
      Constraints:
        Protection Type: protected-preferred
        Maximum SID Depth: 10 
      Dynamic (pce) (inactive)
        Metric Type: NONE,   Path Accumulated Metric: 0 
  LSPs:
    LSP[0]:
      LSP-ID: 2 policy ID: 2 (active)
      Local label: 24015
      State: Programmed
      Binding SID: 24016
  Attributes:
    Binding SID: 24016
    Forward Class: Not Configured
    Steering labeled-services disabled: no
    Steering BGP disabled: no
    IPv6 caps enable: yes
    Invalidation drop enabled: no
    Max Install Standby Candidate Paths: 0
```


```
segment-routing
 traffic-eng
  on-demand color 300
   dynamic
    pcep
    metric
     type te
    !
    disjoint-path group-id 10 type link
   !
  !
```