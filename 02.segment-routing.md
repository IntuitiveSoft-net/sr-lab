# Segment Routing Lab

## Task 1. Get familiar with lab topology

Visualise the router interfaces announced in IS-IS process `core` :   

:keyboard: xrd-1
```bash
show isis interface brief
```
```
IS-IS core Interfaces
    Interface      All     Adjs    Adj Topos  Adv Topos  CLNS   MTU    Prio  
                   OK    L1   L2    Run/Cfg    Run/Cfg                L1   L2
-----------------  ---  ---------  ---------  ---------  ----  ----  --------
Lo0                Yes    -    -      0/0        1/1     No       -    -    - 
Gi0/0/0/0          Yes    -    1      1/1        1/1     Up    1497    -    - 
Gi0/0/0/1          Yes    -    1      1/1        1/1     Up    1497    -    - 
Gi0/0/0/2          Yes    -    0      1/1        1/1     Up    1497    -    - 
```


You can verify the number of neighbors known via IS-IS with the following command : 

:keyboard: xrd-1
```bash
show isis neighbors
```
```
IS-IS core neighbors:
System Id      Interface        SNPA           State Holdtime Type IETF-NSF
xrd-3          Gi0/0/0/0        *PtoP*         Up    23       L2   Capable 
xrd-5          Gi0/0/0/1        *PtoP*         Up    29       L2   Capable 
```

Verify the IS-IS topology. Take a time to verify that you know every other nodes with the expected metric.

:keyboard: xrd-1
```bash
show isis topology
```
```
IS-IS core paths to IPv4 Unicast (Level-2) routers
System Id          Metric    Next-Hop           Interface       SNPA          
xrd-1              --      
xrd-2              30        xrd-5              Gi0/0/0/1       *PtoP*        
xrd-2              30        xrd-3              Gi0/0/0/0       *PtoP*        
xrd-3              10        xrd-3              Gi0/0/0/0       *PtoP*        
xrd-4              20        xrd-3              Gi0/0/0/0       *PtoP*        
xrd-5              10        xrd-5              Gi0/0/0/1       *PtoP*        
xrd-6              20        xrd-5              Gi0/0/0/1       *PtoP*        
xrd-7              40        xrd-3              Gi0/0/0/0       *PtoP*        
```
:question: Questions : 
* Why is xrd-2 node appearing twice ?

Verify routing table.
You should be learning the Loopbacks and interco links from the other nodes of the topology.

:keyboard: xrd-1
```bash
show ip route 
```
```
L    1.1.1.1/32 is directly connected, 00:26:03, Loopback0
i L2 2.2.2.2/32 [115/30] via 100.1.3.3, 00:00:46, GigabitEthernet0/0/0/0
                [115/30] via 100.1.5.5, 00:00:46, GigabitEthernet0/0/0/1
i L2 3.3.3.3/32 [115/10] via 100.1.3.3, 00:25:56, GigabitEthernet0/0/0/0
i L2 4.4.4.4/32 [115/20] via 100.1.3.3, 00:25:52, GigabitEthernet0/0/0/0
i L2 5.5.5.5/32 [115/10] via 100.1.5.5, 00:25:56, GigabitEthernet0/0/0/1
i L2 6.6.6.6/32 [115/20] via 100.1.5.5, 00:25:52, GigabitEthernet0/0/0/1
i L2 7.7.7.7/32 [115/40] via 100.1.3.3, 00:04:39, GigabitEthernet0/0/0/0
C    99.1.10.0/24 is directly connected, 00:26:02, GigabitEthernet0/0/0/2
L    99.1.10.1/32 is directly connected, 00:26:02, GigabitEthernet0/0/0/2
i L2 99.2.20.0/24 [115/40] via 100.1.3.3, 00:00:46, GigabitEthernet0/0/0/0
                  [115/40] via 100.1.5.5, 00:00:46, GigabitEthernet0/0/0/1
C    100.1.3.0/24 is directly connected, 00:26:02, GigabitEthernet0/0/0/0
L    100.1.3.1/32 is directly connected, 00:26:02, GigabitEthernet0/0/0/0
C    100.1.5.0/24 is directly connected, 00:26:02, GigabitEthernet0/0/0/1
L    100.1.5.1/32 is directly connected, 00:26:02, GigabitEthernet0/0/0/1
i L2 100.2.4.0/24 [115/30] via 100.1.3.3, 00:00:46, GigabitEthernet0/0/0/0
i L2 100.2.6.0/24 [115/30] via 100.1.5.5, 00:25:52, GigabitEthernet0/0/0/1
i L2 100.3.4.0/24 [115/20] via 100.1.3.3, 00:25:56, GigabitEthernet0/0/0/0
i L2 100.3.7.0/24 [115/40] via 100.1.3.3, 00:04:39, GigabitEthernet0/0/0/0
i L2 100.4.6.0/24 [115/30] via 100.1.3.3, 00:25:52, GigabitEthernet0/0/0/0
                  [115/30] via 100.1.5.5, 00:25:52, GigabitEthernet0/0/0/1
i L2 100.4.7.0/24 [115/50] via 100.1.3.3, 00:00:46, GigabitEthernet0/0/0/0
i L2 100.5.6.0/24 [115/20] via 100.1.5.5, 00:25:56, GigabitEthernet0/0/0/1
L    127.0.0.0/8 [0/0] via 0.0.0.0, 00:26:06
C    172.28.0.0/24 is directly connected, 00:26:02, MgmtEth0/RP0/CPU0/0
L    172.28.0.1/32 is directly connected, 00:26:02, MgmtEth0/RP0/CPU0/0
```

## Task 2. Configure Segment Routing

Activate segment-routing on xrd-1.

:keyboard: xrd-1
```bash
configure terminal
router isis core
 address-family ipv4 unicast
  segment-routing mpls
 interface Loopback0
  address-family ipv4 unicast
   prefix-sid absolute 16001
commit
```

Adapt the configuration template and configure accordingly lab devices xrd-1 to xrd-6 :

<a href="javascript:scrollLab('SR-MPLS-configurations')">Configurations snippets</a>

Verify the allocated and announced SR prefix and adjacency sids.

:keyboard: xrd-1
```bash
show mpls forwarding
```
```
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes       
Label  Label       or ID              Interface                    Switched    
------ ----------- ------------------ ------------ --------------- ------------
16002  16002       SR Pfx (idx 2)     Gi0/0/0/0    100.1.3.3       288         
       16002       SR Pfx (idx 2)     Gi0/0/0/1    100.1.5.5       0           
16003  Pop         SR Pfx (idx 3)     Gi0/0/0/0    100.1.3.3       0           
16004  16004       SR Pfx (idx 4)     Gi0/0/0/0    100.1.3.3       0           
16005  Pop         SR Pfx (idx 5)     Gi0/0/0/1    100.1.5.5       0           
16006  16006       SR Pfx (idx 6)     Gi0/0/0/1    100.1.5.5       0           
16007  16007       SR Pfx (idx 7)     Gi0/0/0/0    100.1.3.3       224         
24000  Pop         SR Adj (idx 1)     Gi0/0/0/0    100.1.3.3       0           
24001  Pop         SR Adj (idx 3)     Gi0/0/0/0    100.1.3.3       0           
24002  Pop         SR Adj (idx 1)     Gi0/0/0/1    100.1.5.5       0           
24003  Pop         SR Adj (idx 3)     Gi0/0/0/1    100.1.5.5       0 
```

Questions :
* What does `Pop` means ?

Visualize the adjacency SID allocated to xrd-1 interfaces :

:keyboard: xrd-1
```bash
show mpls label table detail 
```
```
Table Label   Owner                           State  Rewrite
----- ------- ------------------------------- ------ -------
0     0       LSD(A)                          InUse  Yes
0     1       LSD(A)                          InUse  Yes
0     2       LSD(A)                          InUse  Yes
0     13      LSD(A)                          InUse  Yes
0     16000   ISIS(A):core                    InUse  No
  (Lbl-blk SRGB, vers:0, (start_label=16000, size=8000)
0     24000   ISIS(A):core                    InUse  Yes
  (SR Adj Segment IPv4, vers:0, index=1, type=0, intf=Gi0/0/0/0, nh=100.1.3.3)
0     24001   ISIS(A):core                    InUse  Yes
  (SR Adj Segment IPv4, vers:0, index=3, type=0, intf=Gi0/0/0/0, nh=100.1.3.3)
0     24002   ISIS(A):core                    InUse  Yes
  (SR Adj Segment IPv4, vers:0, index=1, type=0, intf=Gi0/0/0/1, nh=100.1.5.5)
0     24003   ISIS(A):core                    InUse  Yes
  (SR Adj Segment IPv4, vers:0, index=3, type=0, intf=Gi0/0/0/1, nh=100.1.5.5)
```


:keyboard: xrd-1
```bash
show isis database verbose
```
```
IS-IS core (Level-2) Link State Database
LSPID                 LSP Seq Num  LSP Checksum  LSP Holdtime/Rcvd  ATT/P/OL
xrd-1.00-00         * 0x0000000a   0x8ad2        552  /*            0/0/0
  Area Address:   49.0002
  LSP MTU:        1492
  NLPID:          0xcc
  Router ID:      1.1.1.1
  IP Address:     1.1.1.1
  Hostname:       xrd-1
  Router Cap:     1.1.1.1 D:0 S:0
    Segment Routing: I:1 V:0, SRGB Base: 16000 Range: 8000
    Node Maximum SID Depth: 
      Label Imposition: 10
    SR Algorithm: 
      Algorithm: 0
      Algorithm: 1
  Metric: 10         IS-Extended xrd-3.00
    Local Interface ID: 3, Remote Interface ID: 5
    Interface IP Address: 100.1.3.1
    Neighbor IP Address: 100.1.3.3
    Physical BW: 1000000 kbits/sec
    ADJ-SID: F:0 B:0 V:1 L:1 S:0 P:0 weight:0 Adjacency-sid:24001
  Metric: 10         IS-Extended xrd-5.00
    Local Interface ID: 4, Remote Interface ID: 5
    Interface IP Address: 100.1.5.1
    Neighbor IP Address: 100.1.5.5
    Physical BW: 1000000 kbits/sec
    ADJ-SID: F:0 B:0 V:1 L:1 S:0 P:0 weight:0 Adjacency-sid:24003
  Metric: 0          IP-Extended 1.1.1.1/32
    Prefix-SID Index: 1, Algorithm:0, R:0 N:1 P:0 E:0 V:0 L:0
    Prefix Attribute Flags: X:0 R:0 N:1 E:0 A:0
    Source Router ID: 1.1.1.1
  Metric: 10         IP-Extended 99.1.10.0/24
    Prefix Attribute Flags: X:0 R:0 N:0 E:0 A:0
  Metric: 10         IP-Extended 100.1.3.0/24
    Prefix Attribute Flags: X:0 R:0 N:0 E:0 A:0
  Metric: 10         IP-Extended 100.1.5.0/24
    Prefix Attribute Flags: X:0 R:0 N:0 E:0 A:0
    
  [... output truncated ...]
```

:keyboard: xrd-1
```bash
traceroute 2.2.2.2             
```
```
Type escape sequence to abort.
Tracing the route to 2.2.2.2

 1  100.1.3.3 [MPLS: Label 16002 Exp 0] 2 msec  1 msec  1 msec 
 2  100.3.4.4 [MPLS: Label 16002 Exp 0] 1 msec  1 msec  1 msec 
 3  100.2.4.2 4 msec  *  2 msec 
```

:keyboard: xrd-1
```bash
traceroute sr-mpls multipath 2.2.2.2/32 ver
```
```
Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface, 
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label, 
  'P' - no rx intf label prot, 'p' - premature termination of LSP, 
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

LL!
Path 0 found, 
 output interface GigabitEthernet0/0/0/0 nexthop 100.1.3.3
 source 100.1.3.1 destination 127.0.0.0
  0 100.1.3.1 100.1.3.3 MRU 1500 [Labels: 16002 Exp: 0] multipaths 0
L 1 100.1.3.3 100.3.4.4 MRU 1500 [Labels: 16002 Exp: 0] ret code 8 multipaths 1
L 2 100.3.4.4 100.2.4.2 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 1
! 3 100.2.4.2, ret code 3 multipaths 0
LL!
Path 1 found, 
 output interface GigabitEthernet0/0/0/1 nexthop 100.1.5.5
 source 100.1.5.1 destination 127.0.0.0
  0 100.1.5.1 100.1.5.5 MRU 1500 [Labels: 16002 Exp: 0] multipaths 0
L 1 100.1.5.5 100.5.6.6 MRU 1500 [Labels: 16002 Exp: 0] ret code 8 multipaths 1
L 2 100.5.6.6 100.2.6.2 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 1
! 3 100.2.6.2, ret code 3 multipaths 0

Paths (found/broken/unexplored) (2/0/0)
 Echo Request (sent/fail) (6/0)
 Echo Reply (received/timeout) (6/0)
 Total Time Elapsed 21 ms
```


The route to 2.2.2.2 is indeed known twice with the same metric cost :

:keyboard: xrd-1
```bash
show route 2.2.2.2
```
```
Routing entry for 2.2.2.2/32
  Known via "isis core", distance 115, metric 30, labeled SR, type level-2
  Installed Oct 31 15:44:47.383 for 00:12:24
  Routing Descriptor Blocks
    100.1.3.3, from 2.2.2.2, via GigabitEthernet0/0/0/0
      Route metric is 30
    100.1.5.5, from 2.2.2.2, via GigabitEthernet0/0/0/1
      Route metric is 30
  No advertising protos. 
```